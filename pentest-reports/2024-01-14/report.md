## Penetration testing report for WordBook
### 2024-01-14 09:51 1p22geo <1p22geodecki@gmail.com>
#### Scope: WordBook application, revision e63de26d61091dcf68ebc5274c70195f65348977, branch 1p22geo-dev-1

## Discovered vulnerabilities:

- hash exposure
    - when the browser requests any data about any user, the server discloses all data, including the password hash.
    - AV:N/AC:L/PR:N/UI:N/S:U/C:C/I:C/A:N
- arbitrary file upload
    - the server allows for file uploads in a couple places, and the file type is not validated.
    - the files don't get processed in any way I know of, so remote code execution or file overriding is not possible,
        however you can make the server storage run out by repeatedly submitting relatively small files - requests are not rate limited.
    - AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:N/A:H
- no register validation
    - the adversary might register an account with the email and displayed name identical to an account that already exists, thus impersonating that account.
    - the _id and join date records will be different, but with some automated scripts an attacker might become indistinguishable from the account they are impersonating.
    - AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:H/A:N

## Attack surface

### Directory scanning result

```
-----------------
DIRB v2.22    
By The Dark Raver
-----------------


START_TIME: Sun Jan 14 09:41:26 2024
URL_BASE: http://127.0.0.1:3000/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://127.0.0.1:3000/ ----
+ http://127.0.0.1:3000/cgi-bin/ (CODE:308|SIZE:8)
+ http://127.0.0.1:3000/favicon.ico (CODE:200|SIZE:11694)
+ http://127.0.0.1:3000/in (CODE:307|SIZE:4224)
+ http://127.0.0.1:3000/login (CODE:200|SIZE:6096)
+ http://127.0.0.1:3000/signup (CODE:200|SIZE:6831)
-----------------
END_TIME: Sun Jan 14 09:42:21 2024
DOWNLOADED: 4612 - FOUND: 5




START_TIME: Sun Jan 14 09:42:42 2024
URL_BASE: http://127.0.0.1:3000/in/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://127.0.0.1:3000/in/ ----
+ http://127.0.0.1:3000/in/cgi-bin/ (CODE:308|SIZE:11)
+ http://127.0.0.1:3000/in/user (CODE:307|SIZE:4951)
-----------------
END_TIME: Sun Jan 14 09:43:35 2024
DOWNLOADED: 4612 - FOUND: 2



START_TIME: Sun Jan 14 11:26:12 2024
URL_BASE: http://127.0.0.1:3000/api/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://127.0.0.1:3000/api/ ----
+ http://127.0.0.1:3000/api/cgi-bin/ (CODE:308|SIZE:12)
+ http://127.0.0.1:3000/api/check (CODE:405|SIZE:0)
+ http://127.0.0.1:3000/api/comment (CODE:405|SIZE:0)
+ http://127.0.0.1:3000/api/login (CODE:405|SIZE:0)
+ http://127.0.0.1:3000/api/logout (CODE:307|SIZE:0)
+ http://127.0.0.1:3000/api/post (CODE:401|SIZE:31)
+ http://127.0.0.1:3000/api/register (CODE:405|SIZE:0)
+ http://127.0.0.1:3000/api/upload (CODE:405|SIZE:0)
+ http://127.0.0.1:3000/api/user (CODE:405|SIZE:0)
-----------------
END_TIME: Sun Jan 14 11:27:11 2024
DOWNLOADED: 4612 - FOUND: 9
```

### nmap scan result

```
# Nmap 7.94 scan initiated Sun Jan 14 11:21:40 2024 as: nmap -p 3000 -A -vvvv -oN nmap.txt 127.0.0.1
Nmap scan report for localhost.localdomain (127.0.0.1)
Host is up, received conn-refused (0.00013s latency).
Scanned at 2024-01-14 11:21:40 UTC for 11s

PORT     STATE SERVICE REASON  VERSION
3000/tcp open  ppp?    syn-ack
| fingerprint-strings: 
|   GetRequest, HTTPOptions: 
|     HTTP/1.1 200 OK
|     Vary: RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Url, Accept-Encoding
|     X-Powered-By: Next.js
|     Cache-Control: private, no-cache, no-store, max-age=0, must-revalidate
|     Content-Type: text/html; charset=utf-8
|     Date: Sun, 14 Jan 2024 11:21:51 GMT
|     Connection: close
|     <!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/e9bc9c6577527243.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-8be930b2d5377279.js"/><script src="/_next/static/chunks/fd9d1056-54454afb2d0e23d3.js" async=""></script><script src="/_next/static/chunks/938-696a041ba7ef90b1.js" async=""></script><script src="/_next/static/chunks/main-app-41fdce7b20ef97b8.js" async=""></script><script src="/_next/static/chunks/
|   Help, NCP: 
|     HTTP/1.1 400 Bad Request
|_    Connection: close
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3000-TCP:V=7.94%I=7%D=1/14%Time=65A3C3CF%P=x86_64-pc-linux-gnu%r(Ge
SF:tRequest,358F,"HTTP/1\.1\x20200\x20OK\r\nVary:\x20RSC,\x20Next-Router-S
SF:tate-Tree,\x20Next-Router-Prefetch,\x20Next-Url,\x20Accept-Encoding\r\n
SF:X-Powered-By:\x20Next\.js\r\nCache-Control:\x20private,\x20no-cache,\x2
SF:0no-store,\x20max-age=0,\x20must-revalidate\r\nContent-Type:\x20text/ht
SF:ml;\x20charset=utf-8\r\nDate:\x20Sun,\x2014\x20Jan\x202024\x2011:21:51\
SF:x20GMT\r\nConnection:\x20close\r\n\r\n<!DOCTYPE\x20html><html\x20lang=\
SF:"en\"><head><meta\x20charSet=\"utf-8\"/><meta\x20name=\"viewport\"\x20c
SF:ontent=\"width=device-width,\x20initial-scale=1\"/><link\x20rel=\"style
SF:sheet\"\x20href=\"/_next/static/css/e9bc9c6577527243\.css\"\x20data-pre
SF:cedence=\"next\"/><link\x20rel=\"preload\"\x20as=\"script\"\x20fetchPri
SF:ority=\"low\"\x20href=\"/_next/static/chunks/webpack-8be930b2d5377279\.
SF:js\"/><script\x20src=\"/_next/static/chunks/fd9d1056-54454afb2d0e23d3\.
SF:js\"\x20async=\"\"></script><script\x20src=\"/_next/static/chunks/938-6
SF:96a041ba7ef90b1\.js\"\x20async=\"\"></script><script\x20src=\"/_next/st
SF:atic/chunks/main-app-41fdce7b20ef97b8\.js\"\x20async=\"\"></script><scr
SF:ipt\x20src=\"/_next/static/chunks/")%r(Help,2F,"HTTP/1\.1\x20400\x20Bad
SF:\x20Request\r\nConnection:\x20close\r\n\r\n")%r(NCP,2F,"HTTP/1\.1\x2040
SF:0\x20Bad\x20Request\r\nConnection:\x20close\r\n\r\n")%r(HTTPOptions,358
SF:F,"HTTP/1\.1\x20200\x20OK\r\nVary:\x20RSC,\x20Next-Router-State-Tree,\x
SF:20Next-Router-Prefetch,\x20Next-Url,\x20Accept-Encoding\r\nX-Powered-By
SF::\x20Next\.js\r\nCache-Control:\x20private,\x20no-cache,\x20no-store,\x
SF:20max-age=0,\x20must-revalidate\r\nContent-Type:\x20text/html;\x20chars
SF:et=utf-8\r\nDate:\x20Sun,\x2014\x20Jan\x202024\x2011:21:51\x20GMT\r\nCo
SF:nnection:\x20close\r\n\r\n<!DOCTYPE\x20html><html\x20lang=\"en\"><head>
SF:<meta\x20charSet=\"utf-8\"/><meta\x20name=\"viewport\"\x20content=\"wid
SF:th=device-width,\x20initial-scale=1\"/><link\x20rel=\"stylesheet\"\x20h
SF:ref=\"/_next/static/css/e9bc9c6577527243\.css\"\x20data-precedence=\"ne
SF:xt\"/><link\x20rel=\"preload\"\x20as=\"script\"\x20fetchPriority=\"low\
SF:"\x20href=\"/_next/static/chunks/webpack-8be930b2d5377279\.js\"/><scrip
SF:t\x20src=\"/_next/static/chunks/fd9d1056-54454afb2d0e23d3\.js\"\x20asyn
SF:c=\"\"></script><script\x20src=\"/_next/static/chunks/938-696a041ba7ef9
SF:0b1\.js\"\x20async=\"\"></script><script\x20src=\"/_next/static/chunks/
SF:main-app-41fdce7b20ef97b8\.js\"\x20async=\"\"></script><script\x20src=\
SF:"/_next/static/chunks/");

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jan 14 11:21:51 2024 -- 1 IP address (1 host up) scanned in 11.39 seconds
```

## Discovered vulnerabilities

### Hash exposure

Upon a scroll event, the browser sends requests like /api/post?page=1 with incrementing page numbers, until the request returns no more posts - then, the browser stops.  
You can manually fire a request to /api/post?page=0 to return the last posts, the ones that are given in the initial HTML.  

The JSON response looks like so:
```json
{
    "posts":[
        {
            "_id":"65a3adf9bca4e59d0293b8ae",
            "content":"# Hi everyone!\n## I hope I don't get hacked *here*.\nI quit Facebook just because I got hacked, hope this one is more secure",
            "posted":1705225720697,
            "comments":[],
            "up":0,
            "down":0,
            "author":{
                "_id":"65a3adbbbca4e59d0293b8ab",
                "email":"1p22geo@gmail.com",
                "name":"Bartosz Ge.",
                "hash":"489cd5dbc708c7e541de4d7cd91ce6d0f1613573b7fc5b40d3942ccb9555cf35",
                "added":1705225659915,
                "type":"user"
            }
        }
    ]
}
```

As you can see, the "author" field contains the user password hash, detected to be raw sha256.
This is a critical confidentiality vulnerability, because all passwords are effectively leaked, they just need to be hash-cracked.
Users which didn't submit any comments or posts are safe.

Affected components:
- /api/user endpoint (user.hash field)
- /api/post endpoint (posts.author.hash)
- /api/check endpoint (user.hash)

### Arbitrary file upload

File uploads are not a vulnerability themselves, hovever the WordBook file uploader doesn't validate file type or size, and since requests are not rate limited, you can cause a DoS attack by uploading a lot of files in parallel, taking up all the bandwidth, or by repeatedly uploading the same relatively small file in a script, thus taking up all the storage space on the target host. This vulnerability actually acts beyond the container (if the app is running via Docker), filling up space on the host, and since the container doesn't use a bind mount for /app/uploads, the only way to free up the storage is to clear all the data on the container, with all uploads. This does not affect the database or telemetry servers, since they run on separate containers. However if storage is not periodically cleaned by the administrator, they will run out of space too.

The file upload endpoint is not authenticated too, meaning session timeouts will not stop any file-uploading scripts.

Affected components:
- file upload on /in (both create post and comment)
- file upload on /in/user (update description and gallery upload)

### No register validation

You can register an account with the username and name identical to one that already exists, thus impersonating their identity. This will actually be a new account, with a different ID and depicted by a different database record. However it will appear the same, in the main page. Note that records like join date, submitted posts, account description an account type (not used yet) are tied to the _id, not the email address. After a victim clicks on a post submitted by the fake account, they will go to the fake account's page. When trying to impersonate someone, an adversary would need to precisely copy their description and gallery, and submit many posts with the same content as ones in the original account, and still the posts' submit dates and the user's join date will be different.

Affected components:
- register form on /signup

## Remediation

### Hash exposure

One possible remediation is to make user-queries to the database not return the "hash" field. This can be accomplished using a negative $project mongoDB aggregation stage.
It is also possible to just set the user.hash field to "x" in the variable containing the query result, before returning it in a repsonse.

### Arbitrary file upload

Rate limiting the upload endpoint, measuring the total capacity of files uploaded by each user, and disallowing uploads after the total uploaded files for this user exceed an amount. Also, deleting files not referenced in any post, description or gallery.

### No register validation

Checking if such an email address exists before allowing registration.
